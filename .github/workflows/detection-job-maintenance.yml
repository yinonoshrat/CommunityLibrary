# GitHub Actions Workflow: Detection Job Maintenance
# Purpose: Run detection job cleanup and timeout checking via GitHub Actions
# Triggers: Scheduled cron jobs (twice daily for cleanup, every 5 min for timeout checks)
# NOTE: Requires SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY secrets to be set
# NOTE: Requires Edge Functions to be deployed first (cleanup-detection-jobs, mark-jobs-as-failed-if-stuck)

name: Detection Job Maintenance

on:
  # Temporarily disabled - uncomment after Edge Functions are deployed and secrets are verified
  # schedule:
  #   # Run cleanup daily at 2 AM UTC
  #   - cron: '0 2 * * *'
  #   # Run timeout check every 15 minutes
  #   - cron: '*/15 * * * *'
  workflow_dispatch: # Allow manual trigger for testing

jobs:
  cleanup-detection-jobs:
    if: github.event.schedule == '0 2 * * *' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    name: Cleanup detection job images
    environment: Preview  # Uses Preview environment secrets (development Supabase project)
    
    steps:
      - name: Check out code
        uses: actions/checkout@v4
      
      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.SUPABASE_URL }}" ]; then
            echo "Error: SUPABASE_URL secret is not set in Preview environment"
            exit 1
          fi
          if [ -z "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" ]; then
            echo "Error: SUPABASE_SERVICE_ROLE_KEY secret is not set in Preview environment"
            exit 1
          fi
          echo "✅ Running cleanup against Preview environment (development)"
      
      - name: Call cleanup Edge Function
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            "${{ secrets.SUPABASE_URL }}/functions/v1/cleanup-detection-jobs" \
            -d '{"source":"github-actions"}' \
            -w "\nHTTP Status: %{http_code}\n" \
            -f
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      
      - name: Log cleanup result
        if: success()
        run: echo "✅ Cleanup job completed successfully"
      
      - name: Report cleanup failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            core.setFailed('Cleanup job failed - check logs above')

  check-timeout-jobs:
    if: github.event.schedule == '*/15 * * * *' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    name: Check for timeout detection jobs
    environment: Preview  # Uses Preview environment secrets (development Supabase project)
    
    steps:
      - name: Check out code
        uses: actions/checkout@v4
      
      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.SUPABASE_URL }}" ]; then
            echo "Error: SUPABASE_URL secret is not set in Preview environment"
            exit 1
          fi
          if [ -z "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" ]; then
            echo "Error: SUPABASE_SERVICE_ROLE_KEY secret is not set in Preview environment"
            exit 1
          fi
          echo "✅ Running timeout check against Preview environment (development)"
      
      - name: Call timeout detection Edge Function
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            "${{ secrets.SUPABASE_URL }}/functions/v1/mark-jobs-as-failed-if-stuck" \
            -d '{"source":"github-actions"}' \
            -w "\nHTTP Status: %{http_code}\n" \
            -f
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      
      - name: Log timeout check result
        if: success()
        run: echo "✅ Timeout check completed successfully"
      
      - name: Report timeout check failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            core.setFailed('Timeout check failed - check logs above')

  # Optional: Send status to monitoring service
  notify-on-failure:
    if: failure()
    needs: [cleanup-detection-jobs, check-timeout-jobs]
    runs-on: ubuntu-latest
    name: Notify on job failure
    
    steps:
      - name: Send Slack notification (optional)
        if: vars.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "⚠️ Detection job maintenance failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Detection Job Maintenance Failed*\nRepository: ${{ github.repository }}\nBranch: ${{ github.ref }}\nRun: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                }
              ]
            }
