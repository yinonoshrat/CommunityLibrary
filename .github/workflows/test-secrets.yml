name: Test Secrets Configuration

on:
  workflow_dispatch:

jobs:
  test-secrets-preview:
    runs-on: ubuntu-latest
    name: Verify Preview environment secrets
    environment: Preview
    
    steps:
      - name: Check if secrets exist
        run: |
          echo "Testing Preview environment secret configuration..."
          
          # Check SUPABASE_URL
          if [ -n "${{ secrets.SUPABASE_URL }}" ]; then
            echo "✅ SUPABASE_URL is set in Preview environment"
            # Show only first 20 chars for verification
            echo "URL starts with: $(echo '${{ secrets.SUPABASE_URL }}' | cut -c1-20)..."
          else
            echo "❌ SUPABASE_URL is NOT set in Preview environment"
            exit 1
          fi
          
          # Check SUPABASE_SERVICE_ROLE_KEY
          if [ -n "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" ]; then
            echo "✅ SUPABASE_SERVICE_ROLE_KEY is set in Preview environment"
            # Show only first 20 chars for verification
            echo "Key starts with: $(echo '${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}' | cut -c1-20)..."
          else
            echo "❌ SUPABASE_SERVICE_ROLE_KEY is NOT set in Preview environment"
            exit 1
          fi
          
          echo ""
          echo "✅ All Preview environment secrets are configured correctly!"
      
      - name: Test URL format
        run: |
          URL="${{ secrets.SUPABASE_URL }}"
          if [[ $URL == https://* ]]; then
            echo "✅ URL format is correct (starts with https://)"
          else
            echo "❌ URL format is incorrect. Should start with https://"
            echo "Current format: ${URL:0:10}..."
            exit 1
          fi
